# 网关认证模块集成文档

## 概述
网关服务已成功集成JWT认证和Redis缓存，提供完整的用户认证、授权和缓存管理功能。

## 🎯 已完成的功能

### 1. JWT Token验证
- ✅ 完整的JWT Token解析和验证
- ✅ Token过期时间检查
- ✅ Token黑名单机制
- ✅ 用户信息提取和传递

### 2. Redis缓存集成
- ✅ 响应式Redis操作 (ReactiveRedisTemplate)
- ✅ 用户信息缓存 (30分钟过期)
- ✅ Token黑名单缓存
- ✅ 缓存失败容错处理

### 3. 认证过滤器 (AuthFilter)
- ✅ 全局认证拦截
- ✅ 白名单路径配置
- ✅ 用户信息传递到下游服务
- ✅ 详细的认证日志

### 4. 管理接口 (AuthController)
- ✅ Token验证接口
- ✅ 黑名单管理接口
- ✅ 用户缓存管理接口
- ✅ 服务状态检查接口

## 🔧 架构设计

```
请求 → 网关 → AuthFilter → AuthService → Redis缓存
                ↓              ↓
            JWT验证       用户信息缓存
                ↓              ↓
            添加用户头      黑名单检查
                ↓
            转发到后端服务
```

## 📋 核心组件

### AuthFilter - 认证过滤器
- **路径**: `com.cloudDemo.gateway.filter.AuthFilter`
- **功能**: 全局认证拦截，JWT验证，用户信息传递
- **执行顺序**: Order = 1

### AuthService - 认证服务
- **路径**: `com.cloudDemo.gateway.service.AuthService`
- **功能**: JWT验证、Redis缓存管理、用户信息处理

### RedisConfig - Redis配置
- **路径**: `com.cloudDemo.gateway.config.RedisConfig`
- **功能**: 响应式Redis模板配置，序列化器设置

### AuthController - 管理接口
- **路径**: `com.cloudDemo.gateway.controller.AuthController`
- **功能**: 认证管理API接口

## 🛡️ 安全特性

### 白名单路径
```java
- /api/user/login     // 用户登录
- /api/user/register  // 用户注册
- /api/user/list      // 用户列表（公开）
- /api/order/list     // 订单列表（公开）
- /redis/ping         // Redis测试
- /actuator           // 健康检查
- /favicon.ico        // 图标文件
```

### Token黑名单机制
- 支持将Token加入黑名单
- 可设置黑名单过期时间
- 阻止已注销用户继续访问

### 用户信息缓存
- 缓存时长：30分钟
- 自动刷新机制
- 缓存失败容错

## 🚀 使用方式

### 1. 客户端请求认证
```bash
# 在请求头中添加JWT Token
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" \
     http://localhost:8080/api/user/profile
```

### 2. 管理接口使用

#### 验证Token
```bash
POST http://localhost:8080/auth/validate?token=YOUR_TOKEN
```

#### 添加Token到黑名单
```bash
POST http://localhost:8080/auth/blacklist?token=YOUR_TOKEN&seconds=3600
```

#### 清除用户缓存
```bash
DELETE http://localhost:8080/auth/cache/user123
```

#### 更新用户缓存
```bash
PUT http://localhost:8080/auth/cache/user123?username=张三&roles=admin,user
```

#### 检查服务状态
```bash
GET http://localhost:8080/auth/status
```

## 📊 传递给下游服务的头信息

认证成功后，网关会自动在请求头中添加以下信息：
```
X-User-Id: 用户ID
X-Username: 用户名
X-User-Roles: 用户角色（逗号分隔）
```

下游服务可以直接从这些头信息获取用户信息，无需再次验证JWT。

## ⚙️ 配置信息

### Redis配置 (application.yml)
```yaml
spring:
  data:
    redis:
      host: localhost
      port: 6379
      password: 
      database: 0
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms
```

### 日志配置
```yaml
logging:
  level:
    root: INFO
    com.cloudDemo.gateway: DEBUG  # 网关模块详细日志
```

## 🔄 认证流程

1. **请求到达** → 检查是否在白名单
2. **提取Token** → 从Authorization头或query参数
3. **黑名单检查** → 验证Token是否被禁用
4. **JWT验证** → 解析和验证Token有效性
5. **缓存查询** → 从Redis获取用户信息
6. **信息传递** → 添加用户头信息到请求
7. **转发请求** → 发送到目标服务

## 🚨 错误处理

- **401 Unauthorized**: Token无效、过期或缺失
- **响应头**: `X-Auth-Error` 包含具体错误信息
- **日志记录**: 详细的认证失败日志
- **容错机制**: Redis连接失败时的降级处理

## 🎛️ 运维监控

### 关键指标
- Token验证成功率
- Redis缓存命中率
- 认证延迟统计
- 黑名单使用情况

### 日志示例
```
DEBUG - Authentication successful for user: user123 accessing path: /api/user/profile
WARN  - Access denied: Invalid or expired token for path: /api/secure/data
INFO  - Token added to blacklist: token123...
```

## 📈 性能优化

- **Redis缓存**: 减少JWT解析开销
- **响应式编程**: 非阻塞IO操作
- **连接池**: 优化Redis连接管理
- **容错机制**: 缓存失败不影响认证流程

## 🔮 扩展性

- 支持多种Token提取方式
- 可配置的白名单路径
- 灵活的缓存策略
- 插件化的认证逻辑

现在网关认证模块已经完全集成了JWT和Redis，提供了企业级的认证和授权功能！
