# CloudDemo ç”Ÿäº§å°±ç»ªä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

å°†CloudDemoé¡¹ç›®ä»å­¦ä¹ ç¯å¢ƒæå‡åˆ°ç”Ÿäº§å°±ç»ªçŠ¶æ€ï¼Œé‡ç‚¹å…³æ³¨ï¼š

- **å®¹å™¨åŒ–éƒ¨ç½²**: Docker + Docker Compose
- **ç›‘æ§å‘Šè­¦**: Prometheus + Grafana + AlertManager
- **é“¾è·¯è¿½è¸ª**: Spring Cloud Sleuth + Zipkin
- **æ—¥å¿—èšåˆ**: ELK Stack (Elasticsearch + Logstash + Kibana)
- **å®‰å…¨åŠ å›º**: HTTPS + å®‰å…¨é…ç½®
- **æ€§èƒ½ä¼˜åŒ–**: JVMè°ƒä¼˜ + è¿æ¥æ± ä¼˜åŒ–

## ğŸ³ å®¹å™¨åŒ–éƒ¨ç½²

### Docker é•œåƒæ„å»º

#### 1. åŸºç¡€é•œåƒä¼˜åŒ–

```dockerfile
# Dockerfile.base - å…¬å…±åŸºç¡€é•œåƒ
FROM openjdk:17-jre-slim

# å®‰è£…å¿…è¦å·¥å…·
RUN apt-get update && apt-get install -y \
    curl \
    netcat-openbsd \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºåº”ç”¨ç”¨æˆ·
RUN groupadd -r app && useradd -r -g app app

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app
USER app

# å¥åº·æ£€æŸ¥è„šæœ¬
COPY healthcheck.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/healthcheck.sh
```

#### 2. å¾®æœåŠ¡é•œåƒæ¨¡æ¿

```dockerfile
# Dockerfile.service - å¾®æœåŠ¡é€šç”¨æ¨¡æ¿
FROM cloudDemo/base:latest

# å¤åˆ¶åº”ç”¨JAR
COPY target/*.jar app.jar

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD /usr/local/bin/healthcheck.sh

# å¯åŠ¨åº”ç”¨
ENTRYPOINT ["java", \
    "-XX:+UseContainerSupport", \
    "-XX:MaxRAMPercentage=75.0", \
    "-XX:+UseG1GC", \
    "-XX:+UnlockExperimentalVMOptions", \
    "-XX:+UseCGroupMemoryLimitForHeap", \
    "-Djava.security.egd=file:/dev/./urandom", \
    "-jar", "app.jar"]
```

### Docker Compose ç¼–æ’

#### 1. åŸºç¡€è®¾æ–½æœåŠ¡

```yaml
# docker-compose.infra.yml
version: '3.8'

services:
  nacos:
    image: nacos/nacos-server:v2.5.0
    container_name: nacos
    environment:
      - MODE=standalone
      - SPRING_DATASOURCE_PLATFORM=mysql
      - MYSQL_SERVICE_HOST=mysql
      - MYSQL_SERVICE_DB_NAME=nacos
      - MYSQL_SERVICE_USER=nacos
      - MYSQL_SERVICE_PASSWORD=nacos123
    volumes:
      - nacos-data:/home/nacos/data
    ports:
      - "8848:8848"
    depends_on:
      - mysql
    networks:
      - cloudDemo-network

  mysql:
    image: mysql:8.0
    container_name: mysql
    environment:
      - MYSQL_ROOT_PASSWORD=root123
      - MYSQL_DATABASE=nacos
      - MYSQL_USER=nacos
      - MYSQL_PASSWORD=nacos123
    volumes:
      - mysql-data:/var/lib/mysql
      - ./sql/init:/docker-entrypoint-initdb.d
    ports:
      - "3306:3306"
    networks:
      - cloudDemo-network

  redis:
    image: redis:7-alpine
    container_name: redis
    command: redis-server --appendonly yes --requirepass redis123
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    networks:
      - cloudDemo-network

volumes:
  nacos-data:
  mysql-data:
  redis-data:

networks:
  cloudDemo-network:
    driver: bridge
```

#### 2. å¾®æœåŠ¡åº”ç”¨

```yaml
# docker-compose.services.yml
version: '3.8'

services:
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: user-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER=nacos:8848
      - MYSQL_HOST=mysql:3306
      - REDIS_HOST=redis:6379
    ports:
      - "9000:9000"
    depends_on:
      - nacos
      - mysql
      - redis
    networks:
      - cloudDemo-network
    restart: unless-stopped

  order-service:
    build:
      context: ./services/order-service
      dockerfile: Dockerfile
    container_name: order-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER=nacos:8848
      - MYSQL_HOST=mysql:3306
      - REDIS_HOST=redis:6379
    ports:
      - "8000:8000"
    depends_on:
      - nacos
      - mysql
      - redis
    networks:
      - cloudDemo-network
    restart: unless-stopped

  gateway-service:
    build:
      context: ./services/gateway-service
      dockerfile: Dockerfile
    container_name: gateway-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER=nacos:8848
    ports:
      - "8090:8090"
    depends_on:
      - nacos
    networks:
      - cloudDemo-network
    restart: unless-stopped

networks:
  cloudDemo-network:
    external: true
```

## ğŸ“Š ç›‘æ§å‘Šè­¦ç³»ç»Ÿ

### Prometheus é…ç½®

#### 1. ä¸»é…ç½®æ–‡ä»¶

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alert_rules.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  - job_name: 'user-service'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['user-service:9000']

  - job_name: 'order-service'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['order-service:8000']

  - job_name: 'gateway-service'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['gateway-service:8090']

  - job_name: 'nacos'
    metrics_path: '/nacos/actuator/prometheus'
    static_configs:
      - targets: ['nacos:8848']
```

#### 2. å‘Šè­¦è§„åˆ™

```yaml
# alert_rules.yml
groups:
  - name: cloudDemo-alerts
    rules:
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service {{ $labels.instance }} is down"
          description: "{{ $labels.job }} service has been down for more than 1 minute."

      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High error rate on {{ $labels.instance }}"
          description: "Error rate is {{ $value }} errors per second."

      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High response time on {{ $labels.instance }}"
          description: "95th percentile response time is {{ $value }}s."

      - alert: HighMemoryUsage
        expr: jvm_memory_used_bytes / jvm_memory_max_bytes > 0.8
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is {{ $value | humanizePercentage }}."
```

### Grafana ä»ªè¡¨æ¿

#### 1. å¾®æœåŠ¡æ¦‚è§ˆä»ªè¡¨æ¿

```json
{
  "dashboard": {
    "title": "CloudDemo å¾®æœåŠ¡ç›‘æ§",
    "panels": [
      {
        "title": "æœåŠ¡çŠ¶æ€",
        "type": "stat",
        "targets": [
          {
            "expr": "up",
            "legendFormat": "{{ job }}"
          }
        ]
      },
      {
        "title": "è¯·æ±‚ç‡ (QPS)",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "{{ job }} - {{ method }}"
          }
        ]
      },
      {
        "title": "å“åº”æ—¶é—´åˆ†å¸ƒ",
        "type": "heatmap",
        "targets": [
          {
            "expr": "rate(http_request_duration_seconds_bucket[5m])",
            "legendFormat": "{{ le }}"
          }
        ]
      },
      {
        "title": "JVM å†…å­˜ä½¿ç”¨",
        "type": "graph",
        "targets": [
          {
            "expr": "jvm_memory_used_bytes",
            "legendFormat": "{{ job }} - {{ area }}"
          }
        ]
      }
    ]
  }
}
```

## ğŸ” é“¾è·¯è¿½è¸ª

### Spring Cloud Sleuth é›†æˆ

#### 1. ä¾èµ–é…ç½®

```xml
<!-- pom.xml æ·»åŠ ä¾èµ– -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-sleuth</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-sleuth-zipkin</artifactId>
</dependency>
```

#### 2. é…ç½®æ–‡ä»¶

```properties
# application-docker.properties
spring.sleuth.sampler.probability=1.0
spring.zipkin.base-url=http://zipkin:9411
spring.sleuth.zipkin.config.enabled=true
spring.sleuth.web.client.enabled=true
spring.sleuth.dubbo.enabled=true
```

#### 3. è‡ªå®šä¹‰è¿½è¸ª

```java
@Component
@Slf4j
public class TraceEnhancer {
    
    @Autowired
    private Tracer tracer;
    
    public <T> T executeWithTrace(String operationName, Supplier<T> operation) {
        Span span = tracer.nextSpan()
            .name(operationName)
            .tag("component", "business-logic")
            .start();
        
        try (Tracer.SpanInScope ws = tracer.withSpanInScope(span)) {
            T result = operation.get();
            span.tag("success", "true");
            return result;
        } catch (Exception e) {
            span.tag("error", e.getMessage());
            throw e;
        } finally {
            span.end();
        }
    }
}
```

### Zipkin éƒ¨ç½²

```yaml
# docker-compose.monitoring.yml
services:
  zipkin:
    image: openzipkin/zipkin
    container_name: zipkin
    environment:
      - STORAGE_TYPE=mysql
      - MYSQL_HOST=mysql
      - MYSQL_USER=zipkin
      - MYSQL_PASS=zipkin123
    ports:
      - "9411:9411"
    depends_on:
      - mysql
    networks:
      - cloudDemo-network
```

## ğŸ“‹ æ—¥å¿—èšåˆ

### ELK Stack éƒ¨ç½²

#### 1. Elasticsearch é…ç½®

```yaml
# docker-compose.elk.yml
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.8.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=false
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    networks:
      - cloudDemo-network

  logstash:
    image: docker.elastic.co/logstash/logstash:8.8.0
    container_name: logstash
    volumes:
      - ./logstash/config:/usr/share/logstash/pipeline
    ports:
      - "5044:5044"
    environment:
      - "LS_JAVA_OPTS=-Xms256m -Xmx256m"
    depends_on:
      - elasticsearch
    networks:
      - cloudDemo-network

  kibana:
    image: docker.elastic.co/kibana/kibana:8.8.0
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
    networks:
      - cloudDemo-network
```

#### 2. Logstash é…ç½®

```ruby
# logstash/config/logstash.conf
input {
  beats {
    port => 5044
  }
}

filter {
  if [fields][service] {
    mutate {
      add_field => { "service_name" => "%{[fields][service]}" }
    }
  }

  if [message] =~ /^\{/ {
    json {
      source => "message"
    }
  }

  date {
    match => [ "timestamp", "ISO8601" ]
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "cloudDemo-logs-%{+YYYY.MM.dd}"
  }
}
```

## ğŸ”’ å®‰å…¨åŠ å›º

### HTTPS é…ç½®

#### 1. SSL è¯ä¹¦é…ç½®

```yaml
# application-prod.yml
server:
  port: 443
  ssl:
    enabled: true
    key-store: classpath:keystore.p12
    key-store-password: ${SSL_KEYSTORE_PASSWORD}
    key-store-type: PKCS12
    key-alias: cloudDemo
  
management:
  server:
    port: 8443
    ssl:
      enabled: true
```

#### 2. å®‰ï¿½ï¿½é…ç½®å¢å¼º

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .requiresChannel(channel -> 
                channel.requestMatchers(r -> r.getHeader("X-Forwarded-Proto") != null)
                       .requiresSecure())
            .headers(headers -> 
                headers.frameOptions().deny()
                       .contentTypeOptions().and()
                       .httpStrictTransportSecurity(hstsConfig -> 
                           hstsConfig.maxAgeInSeconds(31536000)
                                    .includeSubdomains(true)))
            .sessionManagement(session -> 
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .csrf().disable();
        
        return http.build();
    }
}
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### JVM è°ƒä¼˜

#### 1. å¯åŠ¨å‚æ•°ä¼˜åŒ–

```bash
# startup.sh
JAVA_OPTS="$JAVA_OPTS -server"
JAVA_OPTS="$JAVA_OPTS -Xms2g -Xmx2g"
JAVA_OPTS="$JAVA_OPTS -XX:+UseG1GC"
JAVA_OPTS="$JAVA_OPTS -XX:MaxGCPauseMillis=200"
JAVA_OPTS="$JAVA_OPTS -XX:+UnlockExperimentalVMOptions"
JAVA_OPTS="$JAVA_OPTS -XX:+UseCGroupMemoryLimitForHeap"
JAVA_OPTS="$JAVA_OPTS -XX:+PrintGCDetails -XX:+PrintGCTimeStamps"
JAVA_OPTS="$JAVA_OPTS -Xloggc:/app/logs/gc.log"
JAVA_OPTS="$JAVA_OPTS -XX:+UseGCLogFileRotation"
JAVA_OPTS="$JAVA_OPTS -XX:NumberOfGCLogFiles=10"
JAVA_OPTS="$JAVA_OPTS -XX:GCLogFileSize=10M"

java $JAVA_OPTS -jar app.jar
```

### è¿æ¥æ± ä¼˜åŒ–

#### 1. æ•°æ®åº“è¿æ¥æ± 

```properties
# application-prod.properties
spring.datasource.hikari.maximum-pool-size=20
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.idle-timeout=600000
spring.datasource.hikari.max-lifetime=1800000
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.validation-timeout=5000
spring.datasource.hikari.leak-detection-threshold=60000
```

#### 2. Redis è¿æ¥æ± 

```properties
spring.redis.lettuce.pool.max-active=20
spring.redis.lettuce.pool.max-idle=8
spring.redis.lettuce.pool.min-idle=2
spring.redis.lettuce.pool.max-wait=-1ms
spring.redis.timeout=3000ms
```

## ğŸš€ éƒ¨ç½²è‡ªåŠ¨åŒ–

### CI/CD Pipeline

#### 1. GitHub Actions é…ç½®

```yaml
# .github/workflows/deploy.yml
name: Deploy CloudDemo

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Build with Maven
      run: mvn clean package -DskipTests
    
    - name: Build Docker images
      run: |
        docker build -t cloudDemo/user-service:${{ github.sha }} ./services/user-service
        docker build -t cloudDemo/order-service:${{ github.sha }} ./services/order-service
        docker build -t cloudDemo/gateway-service:${{ github.sha }} ./services/gateway-service
    
    - name: Deploy to Production
      run: |
        docker-compose -f docker-compose.prod.yml up -d
```

### å¥åº·æ£€æŸ¥è„šæœ¬

```bash
#!/bin/bash
# healthcheck.sh

SERVICE_PORT=${SERVER_PORT:-8080}
HEALTH_ENDPOINT="http://localhost:${SERVICE_PORT}/actuator/health"

# ç­‰å¾…æœåŠ¡å¯åŠ¨
for i in {1..30}; do
    if curl -f -s $HEALTH_ENDPOINT > /dev/null; then
        echo "Service is healthy"
        exit 0
    fi
    echo "Waiting for service to be healthy... ($i/30)"
    sleep 2
done

echo "Service health check failed"
exit 1
```

## ğŸ“Š ç›‘æ§æŒ‡æ ‡ä½“ç³»

### æ ¸å¿ƒæŒ‡æ ‡å®šä¹‰

#### 1. ä¸šåŠ¡æŒ‡æ ‡

- **ç”¨æˆ·æ³¨å†Œç‡**: æ¯æ—¥æ–°ç”¨æˆ·æ³¨å†Œæ•°é‡
- **è®¢å•æˆåŠŸç‡**: è®¢å•åˆ›å»ºæˆåŠŸç‡
- **æ”¯ä»˜è½¬åŒ–ç‡**: è®¢å•æ”¯ä»˜å®Œæˆç‡

#### 2. æŠ€æœ¯æŒ‡æ ‡

- **å“åº”æ—¶é—´**: P95å“åº”æ—¶é—´ < 500ms
- **å¯ç”¨æ€§**: æœåŠ¡å¯ç”¨æ€§ > 99.9%
- **é”™è¯¯ç‡**: é”™è¯¯ç‡ < 0.1%
- **ååé‡**: QPSå³°å€¼å¤„ç†èƒ½åŠ›

#### 3. åŸºç¡€è®¾æ–½æŒ‡æ ‡

- **CPUä½¿ç”¨ç‡**: < 70%
- **å†…å­˜ä½¿ç”¨ç‡**: < 80%
- **ç£ç›˜ä½¿ç”¨ç‡**: < 85%
- **ç½‘ç»œå»¶è¿Ÿ**: < 100ms

---

## ğŸ¯ å®æ–½ä¼˜å…ˆçº§

### ç¬¬ä¸€é˜¶æ®µ (1å‘¨)

1. **å®¹å™¨åŒ–æ”¹é€ **: Dockeré•œåƒæ„å»ºå’Œç¼–æ’
2. **åŸºç¡€ç›‘æ§**: Prometheus + Grafanaæ­å»º
3. **æ—¥å¿—ä¼˜åŒ–**: ç»“æ„åŒ–æ—¥å¿—è¾“å‡º

### ç¬¬äºŒé˜¶æ®µ (1å‘¨)

1. **é“¾è·¯è¿½è¸ª**: Sleuth + Zipkiné›†æˆ
2. **å‘Šè­¦é…ç½®**: AlertManagerè§„åˆ™è®¾ç½®
3. **å®‰å…¨åŠ å›º**: HTTPSå’Œå®‰å…¨é…ç½®

### ç¬¬ä¸‰é˜¶æ®µ (1å‘¨)

1. **æ€§èƒ½è°ƒä¼˜**: JVMå’Œè¿æ¥æ± ä¼˜åŒ–
2. **è‡ªåŠ¨åŒ–éƒ¨ç½²**: CI/CD Pipelineæ­å»º
3. **å‹åŠ›æµ‹è¯•**: ç”Ÿäº§ç¯å¢ƒæ¨¡æ‹Ÿæµ‹è¯•

é€šè¿‡ä»¥ä¸Šä¼˜åŒ–ï¼ŒCloudDemoé¡¹ç›®å°†å…·å¤‡ç”Ÿäº§ç¯å¢ƒçš„éƒ¨ç½²å’Œè¿ç»´èƒ½åŠ›ï¼Œä¸ºé¢è¯•å’Œå®é™…å·¥ä½œåšå¥½å……åˆ†å‡†å¤‡ã€‚
