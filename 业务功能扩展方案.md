# CloudDemo ä¸šåŠ¡åŠŸèƒ½æ‰©å±•æ–¹æ¡ˆ

## ğŸ¯ æ‰©å±•ç›®æ ‡

åœ¨ç°æœ‰CloudDemoå¾®æœåŠ¡åŸºç¡€ä¸Šï¼Œå¢åŠ æ›´ä¸°å¯Œçš„ä¸šåŠ¡åŠŸèƒ½æ¨¡å—ï¼Œæå‡é¡¹ç›®çš„ä¸šåŠ¡å®Œæ•´æ€§å’ŒæŠ€æœ¯æ·±åº¦ï¼š

- **å•†å“ç®¡ç†æ¨¡å—**: å•†å“ä¿¡æ¯ã€åº“å­˜ç®¡ç†ã€ä»·æ ¼ç­–ç•¥
- **è´­ç‰©è½¦åŠŸèƒ½**: è´­ç‰©è½¦æ“ä½œã€å•†å“æ”¶è—ã€ä¼˜æƒ åˆ¸
- **æ”¯ä»˜ç³»ç»Ÿ**: å¤šç§æ”¯ä»˜æ–¹å¼ã€æ”¯ä»˜æµç¨‹ã€é€€æ¬¾å¤„ç†
- **åº“å­˜æœåŠ¡**: å®æ—¶åº“å­˜ã€é¢„æ‰£åº“å­˜ã€åº“å­˜å›æ»š
- **ä¿ƒé”€æ´»åŠ¨**: ç§’æ€æ´»åŠ¨ã€ä¼˜æƒ åˆ¸ã€ç§¯åˆ†ç³»ç»Ÿ
- **æ¶ˆæ¯é€šçŸ¥**: ç«™å†…æ¶ˆæ¯ã€é‚®ä»¶é€šçŸ¥ã€çŸ­ä¿¡éªŒè¯

## ğŸ›ï¸ å•†å“ç®¡ç†æ¨¡å—

### æœåŠ¡æ¶æ„è®¾è®¡

#### 1. å•†å“æœåŠ¡ (product-service:8001)

```java
@RestController
@RequestMapping("/products")
@Tag(name = "å•†å“ç®¡ç†API", description = "å•†å“ä¿¡æ¯çš„å¢åˆ æ”¹æŸ¥æ“ä½œ")
public class ProductController {
    
    @GetMapping("/category/{categoryId}")
    @Operation(summary = "æŒ‰åˆ†ç±»æŸ¥è¯¢å•†å“")
    public ResponseEntity<List<Product>> getProductsByCategory(
            @PathVariable Long categoryId,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size) {
        // åˆ†é¡µæŸ¥è¯¢å•†å“åˆ—è¡¨
    }
    
    @PostMapping
    @Operation(summary = "åˆ›å»ºå•†å“")
    public ResponseEntity<Product> createProduct(
            @Valid @RequestBody CreateProductRequest request) {
        // å•†å“åˆ›å»ºé€»è¾‘
    }
    
    @PutMapping("/{id}/stock")
    @Operation(summary = "æ›´æ–°å•†å“åº“å­˜")
    public ResponseEntity<Void> updateStock(
            @PathVariable Long id,
            @RequestBody UpdateStockRequest request) {
        // åº“å­˜æ›´æ–°é€»è¾‘
    }
}
```

#### 2. å•†å“å®ä½“è®¾è®¡

```java
@Entity
@Table(name = "products")
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class Product {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false, length = 200)
    private String name;
    
    @Column(columnDefinition = "TEXT")
    private String description;
    
    @Column(nullable = false, precision = 10, scale = 2)
    private BigDecimal price;
    
    @Column(nullable = false, precision = 10, scale = 2)
    private BigDecimal originalPrice;
    
    @Column(nullable = false)
    private Integer stock;
    
    @Column(nullable = false)
    private Integer soldCount = 0;
    
    @Enumerated(EnumType.STRING)
    private ProductStatus status = ProductStatus.ACTIVE;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "category_id")
    private Category category;
    
    @Column(length = 500)
    private String imageUrl;
    
    @ElementCollection
    @CollectionTable(name = "product_images")
    private List<String> images = new ArrayList<>();
    
    @ElementCollection
    @MapKeyColumn(name = "spec_name")
    @Column(name = "spec_value")
    @CollectionTable(name = "product_specifications")
    private Map<String, String> specifications = new HashMap<>();
    
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
}

@Entity
@Table(name = "categories")
@Data
public class Category {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false, length = 100)
    private String name;
    
    @Column(length = 500)
    private String description;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "parent_id")
    private Category parent;
    
    @OneToMany(mappedBy = "parent", cascade = CascadeType.ALL)
    private List<Category> children = new ArrayList<>();
    
    private Integer sortOrder = 0;
    private Boolean enabled = true;
}

public enum ProductStatus {
    ACTIVE,     // ä¸Šæ¶
    INACTIVE,   // ä¸‹æ¶
    OUT_OF_STOCK, // ç¼ºè´§
    DISCONTINUED  // åœäº§
}
```

### åº“å­˜ç®¡ç†ç­–ç•¥

#### 1. å®æ—¶åº“å­˜æœåŠ¡

```java
@Service
@Slf4j
public class InventoryService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private ProductMapper productMapper;
    
    private static final String STOCK_KEY_PREFIX = "product:stock:";
    private static final String RESERVED_KEY_PREFIX = "product:reserved:";
    
    /**
     * é¢„æ‰£åº“å­˜ - ç”¨äºä¸‹å•æ—¶é”å®šåº“å­˜
     */
    @Transactional
    public boolean reserveStock(Long productId, Integer quantity) {
        String stockKey = STOCK_KEY_PREFIX + productId;
        String reservedKey = RESERVED_KEY_PREFIX + productId;
        
        // ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§
        String luaScript = """
            local stockKey = KEYS[1]
            local reservedKey = KEYS[2]
            local quantity = tonumber(ARGV[1])
            
            local currentStock = tonumber(redis.call('GET', stockKey) or 0)
            local currentReserved = tonumber(redis.call('GET', reservedKey) or 0)
            
            if currentStock >= quantity then
                redis.call('DECRBY', stockKey, quantity)
                redis.call('INCRBY', reservedKey, quantity)
                return 1
            else
                return 0
            end
            """;
        
        DefaultRedisScript<Long> redisScript = new DefaultRedisScript<>();
        redisScript.setScriptText(luaScript);
        redisScript.setResultType(Long.class);
        
        Long result = redisTemplate.execute(redisScript, 
            Arrays.asList(stockKey, reservedKey), 
            quantity);
        
        return result != null && result == 1;
    }
    
    /**
     * ç¡®è®¤æ‰£å‡åº“å­˜ - æ”¯ä»˜æˆåŠŸåç¡®è®¤æ‰£å‡
     */
    @Transactional
    public void confirmStock(Long productId, Integer quantity) {
        String reservedKey = RESERVED_KEY_PREFIX + productId;
        redisTemplate.opsForValue().decrement(reservedKey, quantity);
        
        // å¼‚æ­¥æ›´æ–°æ•°æ®åº“åº“å­˜
        updateDatabaseStock(productId, quantity);
    }
    
    /**
     * é‡Šæ”¾åº“å­˜ - è®¢å•å–æ¶ˆæ—¶é‡Šæ”¾é¢„æ‰£çš„åº“å­˜
     */
    public void releaseStock(Long productId, Integer quantity) {
        String stockKey = STOCK_KEY_PREFIX + productId;
        String reservedKey = RESERVED_KEY_PREFIX + productId;
        
        redisTemplate.opsForValue().increment(stockKey, quantity);
        redisTemplate.opsForValue().decrement(reservedKey, quantity);
    }
    
    @Async
    private void updateDatabaseStock(Long productId, Integer quantity) {
        productMapper.decreaseStock(productId, quantity);
        log.info("æ•°æ®åº“åº“å­˜å·²æ›´æ–°ï¼Œå•†å“ID: {}, æ‰£å‡æ•°é‡: {}", productId, quantity);
    }
}
```

## ğŸ›’ è´­ç‰©è½¦åŠŸèƒ½

### è´­ç‰©è½¦æœåŠ¡è®¾è®¡

#### 1. è´­ç‰©è½¦å®ä½“

```java
@Entity
@Table(name = "shopping_carts")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class ShoppingCart {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private Long userId;
    
    @Column(nullable = false)
    private Long productId;
    
    @Column(nullable = false)
    private Integer quantity;
    
    @Column(nullable = false)
    private Boolean selected = true;
    
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
    
    // å†—ä½™å•†å“ä¿¡æ¯ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½
    @Transient
    private Product product;
}

@Entity
@Table(name = "user_favorites")
@Data
public class UserFavorite {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private Long userId;
    
    @Column(nullable = false)
    private Long productId;
    
    private LocalDateTime createTime;
}
```

#### 2. è´­ç‰©è½¦æ“ä½œæ¥å£

```java
@RestController
@RequestMapping("/cart")
@Tag(name = "è´­ç‰©è½¦API")
public class ShoppingCartController {
    
    @PostMapping("/add")
    @Operation(summary = "æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦")
    public ResponseEntity<ApiResponse<Void>> addToCart(
            @RequestHeader("Authorization") String token,
            @Valid @RequestBody AddToCartRequest request) {
        
        Long userId = jwtUtil.getUserIdFromToken(token);
        cartService.addToCart(userId, request.getProductId(), request.getQuantity());
        
        return ResponseEntity.ok(ApiResponse.success("å•†å“å·²æ·»åŠ åˆ°è´­ç‰©è½¦"));
    }
    
    @GetMapping
    @Operation(summary = "è·å–è´­ç‰©è½¦åˆ—è¡¨")
    public ResponseEntity<ApiResponse<CartSummary>> getCartItems(
            @RequestHeader("Authorization") String token) {
        
        Long userId = jwtUtil.getUserIdFromToken(token);
        CartSummary summary = cartService.getCartSummary(userId);
        
        return ResponseEntity.ok(ApiResponse.success(summary));
    }
    
    @PutMapping("/update")
    @Operation(summary = "æ›´æ–°è´­ç‰©è½¦å•†å“æ•°é‡")
    public ResponseEntity<ApiResponse<Void>> updateQuantity(
            @RequestHeader("Authorization") String token,
            @Valid @RequestBody UpdateCartRequest request) {
        
        Long userId = jwtUtil.getUserIdFromToken(token);
        cartService.updateQuantity(userId, request.getProductId(), request.getQuantity());
        
        return ResponseEntity.ok(ApiResponse.success("è´­ç‰©è½¦å·²æ›´æ–°"));
    }
    
    @DeleteMapping("/{productId}")
    @Operation(summary = "ä»è´­ç‰©è½¦ç§»é™¤å•†å“")
    public ResponseEntity<ApiResponse<Void>> removeFromCart(
            @RequestHeader("Authorization") String token,
            @PathVariable Long productId) {
        
        Long userId = jwtUtil.getUserIdFromToken(token);
        cartService.removeFromCart(userId, productId);
        
        return ResponseEntity.ok(ApiResponse.success("å•†å“å·²ä»è´­ç‰©è½¦ç§»é™¤"));
    }
}
```

## ğŸ’³ æ”¯ä»˜ç³»ç»Ÿ

### æ”¯ä»˜æœåŠ¡æ¶æ„

#### 1. æ”¯ä»˜æ–¹å¼æšä¸¾

```java
public enum PaymentMethod {
    ALIPAY("alipay", "æ”¯ä»˜å®"),
    WECHAT("wechat", "å¾®ä¿¡æ”¯ä»˜"),
    BANK_CARD("bank_card", "é“¶è¡Œå¡"),
    BALANCE("balance", "ä½™é¢æ”¯ä»˜"),
    CREDIT("credit", "ä¿¡ç”¨æ”¯ä»˜");
    
    private final String code;
    private final String name;
}

public enum PaymentStatus {
    PENDING,    // å¾…æ”¯ä»˜
    PROCESSING, // å¤„ç†ä¸­
    SUCCESS,    // æ”¯ä»˜æˆåŠŸ
    FAILED,     // æ”¯ä»˜å¤±è´¥
    CANCELLED,  // å·²å–æ¶ˆ
    REFUNDED    // å·²é€€æ¬¾
}
```

#### 2. æ”¯ä»˜è®°å½•å®ä½“

```java
@Entity
@Table(name = "payments")
@Data
public class Payment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(unique = true, nullable = false)
    private String paymentNo;
    
    @Column(nullable = false)
    private Long orderId;
    
    @Column(nullable = false)
    private Long userId;
    
    @Column(nullable = false, precision = 10, scale = 2)
    private BigDecimal amount;
    
    @Enumerated(EnumType.STRING)
    private PaymentMethod paymentMethod;
    
    @Enumerated(EnumType.STRING)
    private PaymentStatus status = PaymentStatus.PENDING;
    
    @Column(length = 500)
    private String failureReason;
    
    // ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°è¿”å›çš„äº¤æ˜“å·
    private String thirdPartyTransactionId;
    
    private LocalDateTime createTime;
    private LocalDateTime payTime;
    private LocalDateTime expireTime;
}
```

#### 3. æ”¯ä»˜æ¥å£å®ç°

```java
@Service
@Slf4j
public class PaymentService {
    
    @Autowired
    private PaymentMapper paymentMapper;
    
    @Autowired
    private OrderService orderService;
    
    @Autowired
    private InventoryService inventoryService;
    
    /**
     * åˆ›å»ºæ”¯ä»˜è®¢å•
     */
    @Transactional
    public PaymentResult createPayment(CreatePaymentRequest request) {
        // 1. éªŒè¯è®¢å•çŠ¶æ€
        Orders order = orderService.getById(request.getOrderId());
        if (!OrderStatus.PENDING.equals(order.getStatus())) {
            throw new BusinessException("è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜");
        }
        
        // 2. åˆ›å»ºæ”¯ä»˜è®°å½•
        Payment payment = Payment.builder()
            .paymentNo(generatePaymentNo())
            .orderId(request.getOrderId())
            .userId(request.getUserId())
            .amount(order.getTotalAmount())
            .paymentMethod(request.getPaymentMethod())
            .expireTime(LocalDateTime.now().plusMinutes(30))
            .build();
        
        paymentMapper.insert(payment);
        
        // 3. è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜æ¥å£
        ThirdPartyPaymentResult thirdPartyResult = callThirdPartyPayment(payment);
        
        return PaymentResult.builder()
            .paymentNo(payment.getPaymentNo())
            .qrCode(thirdPartyResult.getQrCode())
            .redirectUrl(thirdPartyResult.getRedirectUrl())
            .build();
    }
    
    /**
     * æ”¯ä»˜å›è°ƒå¤„ç†
     */
    @Transactional
    public void handlePaymentCallback(PaymentCallbackRequest request) {
        Payment payment = paymentMapper.selectByPaymentNo(request.getPaymentNo());
        if (payment == null) {
            log.warn("æ”¯ä»˜å›è°ƒï¼šæ‰¾ä¸åˆ°æ”¯ä»˜è®°å½•ï¼Œæ”¯ä»˜å•å·ï¼š{}", request.getPaymentNo());
            return;
        }
        
        if (PaymentStatus.SUCCESS.equals(payment.getStatus())) {
            log.info("æ”¯ä»˜å›è°ƒï¼šæ”¯ä»˜å·²æˆåŠŸï¼Œå¿½ç•¥é‡å¤å›è°ƒï¼Œæ”¯ä»˜å•å·ï¼š{}", request.getPaymentNo());
            return;
        }
        
        // æ›´æ–°æ”¯ä»˜çŠ¶æ€
        payment.setStatus(PaymentStatus.SUCCESS);
        payment.setPayTime(LocalDateTime.now());
        payment.setThirdPartyTransactionId(request.getTransactionId());
        paymentMapper.updateById(payment);
        
        // æ›´æ–°è®¢å•çŠ¶æ€
        orderService.updateStatus(payment.getOrderId(), OrderStatus.PAID);
        
        // ç¡®è®¤æ‰£å‡åº“å­˜
        Orders order = orderService.getById(payment.getOrderId());
        inventoryService.confirmStock(order.getProductId(), order.getQuantity());
        
        // å‘é€æ”¯ä»˜æˆåŠŸæ¶ˆæ¯
        sendPaymentSuccessMessage(payment);
    }
    
    private void sendPaymentSuccessMessage(Payment payment) {
        // å‘é€MQæ¶ˆæ¯æˆ–å¼‚æ­¥é€šçŸ¥
    }
}
```

## ğŸŠ ä¿ƒé”€æ´»åŠ¨æ¨¡å—

### ç§’æ€æ´»åŠ¨è®¾è®¡

#### 1. ç§’æ€æ´»åŠ¨å®ä½“

```java
@Entity
@Table(name = "seckill_activities")
@Data
public class SeckillActivity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private String name;
    
    @Column(nullable = false)
    private Long productId;
    
    @Column(nullable = false, precision = 10, scale = 2)
    private BigDecimal seckillPrice;
    
    @Column(nullable = false)
    private Integer seckillStock;
    
    @Column(nullable = false)
    private Integer soldCount = 0;
    
    @Column(nullable = false)
    private LocalDateTime startTime;
    
    @Column(nullable = false)
    private LocalDateTime endTime;
    
    @Enumerated(EnumType.STRING)
    private ActivityStatus status = ActivityStatus.PENDING;
    
    // é™è´­æ•°é‡
    private Integer limitPerUser = 1;
    
    private LocalDateTime createTime;
}

public enum ActivityStatus {
    PENDING,    // å¾…å¼€å§‹
    ACTIVE,     // è¿›è¡Œä¸­
    ENDED,      // å·²ç»“æŸ
    CANCELLED   // å·²å–æ¶ˆ
}
```

#### 2. ç§’æ€æœåŠ¡å®ç°

```java
@Service
@Slf4j
public class SeckillService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private SeckillActivityMapper seckillMapper;
    
    private static final String SECKILL_STOCK_KEY = "seckill:stock:";
    private static final String SECKILL_USER_KEY = "seckill:user:";
    
    /**
     * å‚ä¸ç§’æ€
     */
    public SeckillResult participateSeckill(Long activityId, Long userId) {
        // 1. æ£€æŸ¥æ´»åŠ¨çŠ¶æ€
        SeckillActivity activity = seckillMapper.selectById(activityId);
        if (!isActivityValid(activity)) {
            return SeckillResult.fail("æ´»åŠ¨ä¸å­˜åœ¨æˆ–å·²ç»“æŸ");
        }
        
        // 2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å‚ä¸
        String userKey = SECKILL_USER_KEY + activityId + ":" + userId;
        if (redisTemplate.hasKey(userKey)) {
            return SeckillResult.fail("æ‚¨å·²å‚ä¸è¿‡è¯¥æ´»åŠ¨");
        }
        
        // 3. å°è¯•æ‰£å‡åº“å­˜
        String stockKey = SECKILL_STOCK_KEY + activityId;
        String luaScript = """
            local stockKey = KEYS[1]
            local userKey = KEYS[2]
            local userId = ARGV[1]
            
            local currentStock = tonumber(redis.call('GET', stockKey) or 0)
            if currentStock > 0 then
                redis.call('DECR', stockKey)
                redis.call('SETEX', userKey, 86400, userId)
                return 1
            else
                return 0
            end
            """;
        
        DefaultRedisScript<Long> redisScript = new DefaultRedisScript<>();
        redisScript.setScriptText(luaScript);
        redisScript.setResultType(Long.class);
        
        Long result = redisTemplate.execute(redisScript, 
            Arrays.asList(stockKey, userKey), 
            userId.toString());
        
        if (result != null && result == 1) {
            // å¼‚æ­¥åˆ›å»ºè®¢å•
            createSeckillOrderAsync(activity, userId);
            return SeckillResult.success("ç§’æ€æˆåŠŸï¼Œè¯·åŠæ—¶æ”¯ä»˜");
        } else {
            return SeckillResult.fail("å•†å“å·²å”®ç½„");
        }
    }
    
    @Async
    private void createSeckillOrderAsync(SeckillActivity activity, Long userId) {
        try {
            CreateOrderRequest orderRequest = CreateOrderRequest.builder()
                .userId(userId)
                .productId(activity.getProductId())
                .quantity(1)
                .totalAmount(activity.getSeckillPrice())
                .orderType(OrderType.SECKILL)
                .seckillActivityId(activity.getId())
                .build();
            
            orderService.createOrder(orderRequest);
            log.info("ç§’æ€è®¢å•åˆ›å»ºæˆåŠŸï¼Œæ´»åŠ¨ID: {}, ç”¨æˆ·ID: {}", activity.getId(), userId);
        } catch (Exception e) {
            log.error("ç§’æ€è®¢å•åˆ›å»ºå¤±è´¥", e);
            // å›æ»šåº“å­˜
            rollbackSeckillStock(activity.getId(), userId);
        }
    }
}
```

### ä¼˜æƒ åˆ¸ç³»ç»Ÿ

#### 1. ä¼˜æƒ åˆ¸å®ä½“è®¾è®¡

```java
@Entity
@Table(name = "coupons")
@Data
public class Coupon {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private String name;
    
    @Column(unique = true, nullable = false)
    private String code;
    
    @Enumerated(EnumType.STRING)
    private CouponType type;
    
    // æŠ˜æ‰£å€¼ï¼šæ»¡å‡é‡‘é¢æˆ–æŠ˜æ‰£æ¯”ä¾‹
    @Column(nullable = false, precision = 10, scale = 2)
    private BigDecimal discountValue;
    
    // ä½¿ç”¨é—¨æ§›
    @Column(precision = 10, scale = 2)
    private BigDecimal minAmount;
    
    // å‘è¡Œæ€»é‡
    @Column(nullable = false)
    private Integer totalCount;
    
    // å·²é¢†å–æ•°é‡
    @Column(nullable = false)
    private Integer receivedCount = 0;
    
    // å·²ä½¿ç”¨æ•°é‡
    @Column(nullable = false)
    private Integer usedCount = 0;
    
    @Column(nullable = false)
    private LocalDateTime startTime;
    
    @Column(nullable = false)
    private LocalDateTime endTime;
    
    @Enumerated(EnumType.STRING)
    private CouponStatus status = CouponStatus.ACTIVE;
}

public enum CouponType {
    FULL_REDUCTION,  // æ»¡å‡
    DISCOUNT,        // æŠ˜æ‰£
    FIXED_AMOUNT     // å›ºå®šé‡‘é¢
}

@Entity
@Table(name = "user_coupons")
@Data
public class UserCoupon {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private Long userId;
    
    @Column(nullable = false)
    private Long couponId;
    
    @Enumerated(EnumType.STRING)
    private UserCouponStatus status = UserCouponStatus.UNUSED;
    
    private Long orderId; // ä½¿ç”¨çš„è®¢å•ID
    
    private LocalDateTime receiveTime;
    private LocalDateTime useTime;
    private LocalDateTime expireTime;
}
```

## ğŸ“¬ æ¶ˆæ¯é€šçŸ¥æ¨¡å—

### æ¶ˆæ¯æœåŠ¡è®¾è®¡

#### 1. æ¶ˆæ¯å®ä½“

```java
@Entity
@Table(name = "messages")
@Data
public class Message {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private Long userId;
    
    @Column(nullable = false)
    private String title;
    
    @Column(columnDefinition = "TEXT")
    private String content;
    
    @Enumerated(EnumType.STRING)
    private MessageType type;
    
    @Column(nullable = false)
    private Boolean isRead = false;
    
    private LocalDateTime createTime;
    private LocalDateTime readTime;
}

public enum MessageType {
    SYSTEM,      // ç³»ç»Ÿæ¶ˆæ¯
    ORDER,       // è®¢å•æ¶ˆæ¯
    PROMOTION,   // ä¿ƒé”€æ¶ˆæ¯
    PAYMENT      // æ”¯ä»˜æ¶ˆæ¯
}
```

#### 2. é‚®ä»¶é€šçŸ¥æœåŠ¡

```java
@Service
@Slf4j
public class EmailNotificationService {
    
    @Autowired
    private JavaMailSender mailSender;
    
    @Value("${spring.mail.username}")
    private String fromEmail;
    
    @Async
    public void sendOrderConfirmationEmail(String toEmail, Orders order) {
        try {
            MimeMessage message = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(message, true, "UTF-8");
            
            helper.setFrom(fromEmail);
            helper.setTo(toEmail);
            helper.setSubject("è®¢å•ç¡®è®¤é€šçŸ¥ - " + order.getOrderNo());
            
            String content = buildOrderConfirmationContent(order);
            helper.setText(content, true);
            
            mailSender.send(message);
            log.info("è®¢å•ç¡®è®¤é‚®ä»¶å‘é€æˆåŠŸï¼Œæ”¶ä»¶äºº: {}, è®¢å•å·: {}", toEmail, order.getOrderNo());
        } catch (Exception e) {
            log.error("è®¢å•ç¡®è®¤é‚®ä»¶å‘é€å¤±è´¥", e);
        }
    }
    
    private String buildOrderConfirmationContent(Orders order) {
        return String.format("""
            <html>
            <body>
                <h2>è®¢å•ç¡®è®¤</h2>
                <p>å°Šæ•¬çš„ç”¨æˆ·ï¼Œæ‚¨çš„è®¢å•å·²ç¡®è®¤ï¼š</p>
                <ul>
                    <li>è®¢å•å·ï¼š%s</li>
                    <li>è®¢å•é‡‘é¢ï¼šï¿¥%.2f</li>
                    <li>ä¸‹å•æ—¶é—´ï¼š%s</li>
                </ul>
                <p>æˆ‘ä»¬å°†å°½å¿«ä¸ºæ‚¨å¤„ç†è®¢å•ï¼Œæ„Ÿè°¢æ‚¨çš„è´­ä¹°ï¼</p>
            </body>
            </html>
            """, 
            order.getOrderNo(), 
            order.getTotalAmount(), 
            order.getCreateTime());
    }
}
```

## ğŸ”„ åˆ†å¸ƒå¼äº‹åŠ¡

### Seata é›†æˆ

#### 1. ä¾èµ–é…ç½®

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
</dependency>
```

#### 2. åˆ†å¸ƒå¼äº‹åŠ¡å®ç°

```java
@Service
@Slf4j
public class OrderTransactionService {
    
    @Autowired
    private OrderService orderService;
    
    @Autowired
    private PaymentService paymentService;
    
    @Autowired
    private InventoryService inventoryService;
    
    @Autowired
    private UserService userService;
    
    /**
     * åˆ›å»ºè®¢å•çš„åˆ†å¸ƒå¼äº‹åŠ¡
     */
    @GlobalTransactional(name = "create-order-transaction", rollbackFor = Exception.class)
    public OrderResult createOrderWithTransaction(CreateOrderRequest request) {
        try {
            // 1. æ‰£å‡åº“å­˜
            boolean stockReserved = inventoryService.reserveStock(
                request.getProductId(), request.getQuantity());
            if (!stockReserved) {
                throw new BusinessException("åº“å­˜ä¸è¶³");
            }
            
            // 2. æ‰£å‡ç”¨æˆ·ä½™é¢ï¼ˆå¦‚æœä½¿ç”¨ä½™é¢æ”¯ä»˜ï¼‰
            if (PaymentMethod.BALANCE.equals(request.getPaymentMethod())) {
                userService.deductBalance(request.getUserId(), request.getTotalAmount());
            }
            
            // 3. åˆ›å»ºè®¢å•
            Orders order = orderService.createOrder(request);
            
            // 4. åˆ›å»ºæ”¯ä»˜è®°å½•
            if (!PaymentMethod.BALANCE.equals(request.getPaymentMethod())) {
                paymentService.createPayment(CreatePaymentRequest.builder()
                    .orderId(order.getId())
                    .userId(request.getUserId())
                    .paymentMethod(request.getPaymentMethod())
                    .build());
            }
            
            log.info("è®¢å•åˆ›å»ºåˆ†å¸ƒå¼äº‹åŠ¡æˆåŠŸï¼Œè®¢å•ID: {}", order.getId());
            return OrderResult.success(order);
            
        } catch (Exception e) {
            log.error("è®¢å•åˆ›å»ºåˆ†å¸ƒå¼äº‹åŠ¡å¤±è´¥", e);
            throw e; // æŠ›å‡ºå¼‚å¸¸è§¦å‘å…¨å±€å›æ»š
        }
    }
}
```

## ğŸ“Š æ•°æ®ç»Ÿè®¡ä¸åˆ†æ

### ä¸šåŠ¡æŒ‡æ ‡ç»Ÿè®¡

#### 1. é”€å”®ç»Ÿè®¡æœåŠ¡

```java
@Service
@Slf4j
public class SalesStatisticsService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * è·å–é”€å”®æ¦‚è§ˆ
     */
    @Cacheable(value = "sales_overview", key = "#date")
    public SalesOverview getSalesOverview(LocalDate date) {
        LocalDateTime startTime = date.atStartOfDay();
        LocalDateTime endTime = date.atTime(23, 59, 59);
        
        // è®¢å•ç»Ÿè®¡
        OrderStatistics orderStats = orderMapper.getOrderStatistics(startTime, endTime);
        
        // å•†å“é”€å”®æ’è¡Œ
        List<ProductSalesRank> productRanks = orderMapper.getProductSalesRank(startTime, endTime, 10);
        
        // ç”¨æˆ·æ¶ˆè´¹æ’è¡Œ
        List<UserConsumptionRank> userRanks = orderMapper.getUserConsumptionRank(startTime, endTime, 10);
        
        return SalesOverview.builder()
            .date(date)
            .orderCount(orderStats.getOrderCount())
            .totalAmount(orderStats.getTotalAmount())
            .avgOrderAmount(orderStats.getAvgOrderAmount())
            .productRanks(productRanks)
            .userRanks(userRanks)
            .build();
    }
    
    /**
     * å®æ—¶é”€å”®æ•°æ®
     */
    public RealtimeSalesData getRealtimeSalesData() {
        String todayKey = "sales:today:" + LocalDate.now();
        
        Map<Object, Object> todayData = redisTemplate.opsForHash().entries(todayKey);
        
        return RealtimeSalesData.builder()
            .todayOrderCount(getLongValue(todayData, "orderCount"))
            .todayAmount(getBigDecimalValue(todayData, "amount"))
            .onlineUserCount(getOnlineUserCount())
            .build();
    }
    
    /**
     * æ›´æ–°å®æ—¶é”€å”®æ•°æ®
     */
    @EventListener
    public void handleOrderPaidEvent(OrderPaidEvent event) {
        String todayKey = "sales:today:" + LocalDate.now();
        
        redisTemplate.opsForHash().increment(todayKey, "orderCount", 1);
        redisTemplate.opsForHash().increment(todayKey, "amount", 
            event.getOrder().getTotalAmount().doubleValue());
        
        // è®¾ç½®è¿‡æœŸæ—¶é—´ä¸ºæ˜å¤©å‡Œæ™¨
        redisTemplate.expireAt(todayKey, 
            LocalDate.now().plusDays(1).atStartOfDay().atZone(ZoneId.systemDefault()).toInstant());
    }
}
```

---

## ğŸš€ å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒä¸šåŠ¡æ‰©å±• (2å‘¨)

1. **å•†å“ç®¡ç†æ¨¡å—**: å•†å“CRUDã€åˆ†ç±»ç®¡ç†ã€åº“å­˜ç®¡ç†
2. **è´­ç‰©è½¦åŠŸèƒ½**: æ·»åŠ /åˆ é™¤å•†å“ã€æ•°é‡è°ƒæ•´ã€æ”¶è—åŠŸèƒ½
3. **åŸºç¡€æ”¯ä»˜**: æ”¯ä»˜å®ã€å¾®ä¿¡æ”¯ä»˜é›†æˆ

### ç¬¬äºŒé˜¶æ®µï¼šé«˜çº§åŠŸèƒ½ (2å‘¨)

1. **åº“å­˜ä¼˜åŒ–**: é¢„æ‰£åº“å­˜ã€åˆ†å¸ƒå¼é”ã€åº“å­˜å›æ»š
2. **ä¿ƒé”€ç³»ç»Ÿ**: ä¼˜æƒ åˆ¸ã€ç§’æ€æ´»åŠ¨
3. **æ¶ˆæ¯é€šçŸ¥**: é‚®ä»¶ã€ç«™å†…æ¶ˆæ¯

### ç¬¬ä¸‰é˜¶æ®µï¼šåˆ†å¸ƒå¼äº‹åŠ¡ä¸ç»Ÿè®¡ (1å‘¨)

1. **Seataé›†æˆ**: åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†
2. **æ•°æ®ç»Ÿè®¡**: é”€å”®ç»Ÿè®¡ã€å®æ—¶æ•°æ®
3. **æ€§èƒ½ä¼˜åŒ–**: ç¼“å­˜ç­–ç•¥ã€å¼‚æ­¥å¤„ç†

é€šè¿‡ä»¥ä¸Šä¸šåŠ¡åŠŸèƒ½æ‰©å±•ï¼ŒCloudDemoé¡¹ç›®å°†æˆä¸ºä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€æŠ€æœ¯å…¨é¢çš„ç”µå•†å¾®æœåŠ¡ç³»ç»Ÿï¼Œå¤§å¤§æå‡é¡¹ç›®çš„é¢è¯•ä»·å€¼å’ŒæŠ€æœ¯å«é‡ã€‚
